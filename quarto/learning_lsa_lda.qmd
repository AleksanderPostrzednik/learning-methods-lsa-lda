---
title: "Learning Methods Analysis"
format: revealjs
---

# Title

## Which study method works best?

---

# Agenda

1.  Data load
2.  Cleaning
3.  LSA
4.  LDA
5.  Sentiment
6.  Conclusions

---

```{r setup}
library(tidyverse)
library(tidytext)
library(lsa)
library(topicmodels)
library(umap)
library(ggwordcloud)
library(textmineR)
library(plotly)
library(janitor)
library(tm) # for weightTfIdf
library(textdata)

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

---

```{r data-load}
# Corrected file path to be relative to the qmd file location
df_raw <- read_csv("../data/student_performance_large_dataset.csv") %>%
  janitor::clean_names()

# Create a text column for analysis by combining categorical columns.
df_raw <- df_raw %>%
  mutate(text_for_analysis = paste(preferred_learning_style, self_reported_stress_level, final_grade))

# Check for required columns after cleaning names
required_cols <- c("gender", "exam_score_percent", "preferred_learning_style", "text_for_analysis")
missing <- setdiff(required_cols, names(df_raw))
if (length(missing) > 0) {
  stop(paste("Missing columns:", paste(missing, collapse = ", ")))
}
```

---

```{r clean}
# Use the newly created text column and correct column names
text_df <- df_raw %>%
  mutate(document = row_number()) %>%
  select(document, text_column = text_for_analysis, learning_style = preferred_learning_style, performance = exam_score_percent) %>%
  unnest_tokens(word, text_column) %>%
  anti_join(stop_words, by = "word")
```

---

```{r lsa}
term_mat <- text_df %>%
  count(document, word) %>%
  cast_dtm(document, word, n)

# Check if term_mat is empty
if (nrow(term_mat) == 0 || ncol(term_mat) == 0) {
  stop("Document-term matrix is empty. Check cleaning steps.")
}

term_tfidf <- weightTfIdf(term_mat)
lsa_res <- lsa(term_tfidf, dims = 2) 

coords <- as.data.frame(lsa_res$dk)
coords$doc <- rownames(coords)

coords %>%
  ggplot(aes(V1, V2)) +
  geom_point() +
  theme_minimal()
```

---

```{r lda}
lda_model <- LDA(term_mat, k = 4, control = list(seed = 123))
terms(lda_model, 10) %>%
  knitr::kable()
```

```{r lda-prepare}
# Explicitly use the posterior function from the topicmodels package
doc_topics <- topicmodels::posterior(lda_model)$topics
topic_df <- as.data.frame(doc_topics)
topic_df$document <- as.integer(rownames(topic_df))
topic_df$dominant_topic <- apply(doc_topics, 1, which.max)

sentiment_doc <- text_df %>%
  inner_join(get_sentiments("afinn"), by = "word") %>%
  group_by(document) %>%
  summarise(sentiment = sum(value, na.rm = TRUE), .groups = "drop")

meta_df <- df_raw %>%
  mutate(document = row_number()) %>%
  select(document, learning_style = preferred_learning_style, performance = exam_score_percent)

topic_meta <- topic_df %>%
  left_join(meta_df, by = "document") %>%
  left_join(sentiment_doc, by = "document")
```

---

```{r sentiment}
text_df %>%
  inner_join(get_sentiments("nrc"), by = "word") %>%
  count(sentiment) %>%
  ggplot(aes(sentiment, n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  theme_minimal()
```

---

## Learning Style Comparison

```{r style-comparison}
style_summary <- topic_meta %>%
  filter(!is.na(learning_style)) %>%
  group_by(learning_style) %>%
  summarise(avg_sentiment = mean(sentiment, na.rm = TRUE))

p_style <- ggplot(style_summary,
                  aes(learning_style, avg_sentiment, fill = learning_style)) +
  geom_col(show.legend = FALSE) +
  theme_minimal()

ggplotly(p_style)
```

---

## Topic Clusters (UMAP)

```{r umap}
umap_res <- umap(lsa_res$dk)
umap_df <- as.data.frame(umap_res$layout)
colnames(umap_df) <- c("Dim1", "Dim2")
umap_df$document <- as.integer(coords$doc)
umap_df <- left_join(umap_df, topic_meta, by = "document")

p_umap <- ggplot(umap_df,
                 aes(Dim1, Dim2, color = learning_style,
                     text = paste0("Doc ", document,
                                    "<br>Topic ", dominant_topic))) +
  geom_point() +
  theme_minimal()

ggplotly(p_umap)
```

---

## Topic-wise Insights

```{r topic-insights}
topic_stats <- topic_meta %>%
  filter(!is.na(dominant_topic)) %>%
  group_by(dominant_topic) %>%
  summarise(
    responses = n(),
    avg_sentiment = mean(sentiment, na.rm = TRUE),
    avg_perf = mean(performance, na.rm = TRUE)
  )

knitr::kable(topic_stats)
```

---

# Conclusions

- LSA and LDA highlight topic structure
- Sentiment shows overall tone
- Further tuning and validation required
- **TODO**: integrate additional metadata
